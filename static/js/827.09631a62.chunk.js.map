{"version":3,"file":"static/js/827.09631a62.chunk.js","mappings":"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","sources":["components/Back.tsx","components/PlyrPlayer.tsx","components/player/VideoDoesNotLoadModal.tsx","components/Player.tsx","views/Player.tsx","store/movies/thunks.ts"],"sourcesContent":["import './Back.scss'\nimport React, { FunctionComponent, useCallback } from 'react'\nimport classNames from 'classnames'\nimport { useNavigate } from 'react-router-dom'\n\ntype BackProps = {\n  children?: React.ReactNode\n}\n\nexport const Back: FunctionComponent<BackProps> = ({ children }) => {\n  const navigate = useNavigate()\n\n  const isDisabled = history.length <= 2\n\n  const handleClick = useCallback(() => navigate(-1), [navigate])\n\n  return (\n    <div\n      className={classNames('Back', { disabled: isDisabled })}\n      onClick={handleClick}\n    >\n      {children}\n    </div>\n  )\n}\n","import React, { useEffect } from 'react'\nimport {\n  buildCaptionSrcLang,\n  buildFileDownloadUrl,\n  buildItemUrl,\n  buildVideoSize,\n  buildVideoType,\n} from '../util'\nimport { Caption } from '../types/files/Caption'\nimport { Episode } from '../types/items/Episode'\nimport { Movie } from '../types/items/Movie'\nimport Plyr from 'plyr'\nimport { Provider } from '../types/providers/Provider'\nimport { RootState } from '../store'\nimport { Video } from '../types/files/Video'\nimport { providersSelector } from '../store/auth/selectors'\nimport { useNavigate } from 'react-router'\nimport { useSelector } from 'react-redux'\n\nconst findProvider = (providers: Provider[], providerId: string) => {\n  const provider = providers.find(({ id }) => id === providerId)\n  if (provider === undefined)\n    throw new Error('Internal error: provider of item does not exist.')\n  return provider\n}\n\nconst buildSource =\n  (providers: Provider[]) =>\n  (video: Video): Plyr.Source => {\n    const provider = findProvider(providers, video.provider.providerId)\n    return {\n      src: buildFileDownloadUrl(provider, video.provider),\n      type: `video/${buildVideoType(video)}`,\n      size: buildVideoSize(video.provider),\n    }\n  }\n\nconst buildCaption =\n  (providers: Provider[]) =>\n  (caption: Caption): Plyr.Track => {\n    const provider = findProvider(providers, caption.provider.providerId)\n    return {\n      kind: 'captions',\n      label: caption.name,\n      srcLang: buildCaptionSrcLang(caption),\n      src: buildFileDownloadUrl(provider, caption.provider),\n    }\n  }\n\ntype PlyrPlayerProps = {\n  id: string\n  item: Movie | Episode\n  startAt?: number\n\n  onProgress: (progress: number) => void\n}\n\nexport const PlyrPlayer = ({\n  id,\n  item,\n  startAt,\n  onProgress,\n}: PlyrPlayerProps) => {\n  const navigate = useNavigate()\n\n  const providers = useSelector((state: RootState) =>\n    providersSelector(state.auth),\n  )\n\n  useEffect(() => {\n    let hasForwarded = false\n\n    const player = new Plyr(`video.PlyrPlayer#${id}`, {\n      debug: process.env.NODE_ENV === 'development',\n      controls: [\n        'play',\n        'progress',\n        'current-time',\n        'mute',\n        'volume',\n        'captions',\n        'settings',\n        'fullscreen',\n      ],\n      settings: ['captions', 'quality'],\n      autoplay: true,\n      invertTime: true,\n      toggleInvert: true,\n    })\n\n    player.source = {\n      type: 'video',\n      title: item.title,\n      sources: item.sources.map(buildSource(providers)),\n      tracks: item.captions.map(buildCaption(providers)),\n    }\n\n    player.on('canplay', () => {\n      if (hasForwarded || startAt === undefined || player.duration < startAt)\n        return\n      player.forward(startAt)\n      hasForwarded = true\n    })\n\n    player.on('ended', () => {\n      navigate(buildItemUrl(item))\n    })\n\n    return () => {\n      if (player.ended) onProgress(0)\n      else if (player.currentTime !== 0) onProgress(player.currentTime)\n\n      player.destroy()\n    }\n  }, [id, item, navigate, onProgress, providers, startAt])\n\n  return (\n    <video\n      className=\"PlyrPlayer\"\n      id={id}\n      crossOrigin=\"anonymous\"\n      playsInline\n      controls\n    />\n  )\n}\n","import './VideoDoesNotLoadModal.scss'\nimport React, { useCallback } from 'react'\nimport { Trans, useTranslation } from 'react-i18next'\nimport { Modal } from '../Modal'\n\ntype VideoDoesNotLoadModalProps = {\n  isActive: boolean\n\n  onClose: () => void\n}\n\nexport const VideoDoesNotLoadModal = ({\n  isActive,\n  onClose,\n}: VideoDoesNotLoadModalProps) => {\n  const { t } = useTranslation()\n\n  const handleReload = useCallback(() => window.location.reload(), [])\n\n  return (\n    <div className=\"VideoDoesNotLoadModal\">\n      <Modal isActive={isActive} onClose={onClose}>\n        <h2>{t(\"The video doesn't load?\")}</h2>\n        <p className=\"small\">\n          <Trans>\n            Restarting may help. Please{' '}\n            <a\n              href=\"https://github.com/jonhue/plaain/issues/new\"\n              target=\"_blank\"\n              rel=\"noopener noreferrer\"\n            >\n              report the issue\n            </a>{' '}\n            if it persists.\n          </Trans>\n        </p>\n        <button className=\"small\" onClick={handleReload}>\n          {t('Reload')}\n        </button>\n      </Modal>\n    </div>\n  )\n}\n","import './Player.scss'\nimport { Back } from './Back'\nimport { Episode } from '../types/items/Episode'\nimport { Link } from 'react-router-dom'\nimport { Movie } from '../types/items/Movie'\nimport { PlyrPlayer } from './PlyrPlayer'\nimport React from 'react'\nimport { VideoDoesNotLoadModal } from './player/VideoDoesNotLoadModal'\nimport { buildItemUrl } from '../util'\nimport { useModal } from '../hooks/modal'\nimport { useTranslation } from 'react-i18next'\n\ntype PlayerProps = {\n  item: Movie | Episode\n  startAt?: number\n\n  onProgress: (progress: number) => void\n}\n\nexport const Player = ({ item, startAt, onProgress }: PlayerProps) => {\n  const { t } = useTranslation()\n\n  const [\n    showVideoDoesNotLoadModal,\n    handleShowVideoDoesNotLoadModal,\n    handleCloseVideoDoesNotLoadModal,\n  ] = useModal()\n\n  return (\n    <div className=\"Player\">\n      <PlyrPlayer\n        item={item}\n        startAt={startAt}\n        onProgress={onProgress}\n        id=\"player\"\n      />\n      <div className=\"Player__content\">\n        <div className=\"Player__content__header\">\n          <h1>\n            <Link to={buildItemUrl(item)}>{item.title}</Link>\n          </h1>\n          <div className=\"Player__content__header__actions\">\n            <a\n              onClick={(e) => {\n                e.preventDefault()\n                handleShowVideoDoesNotLoadModal()\n              }}\n            >\n              {t('Video not loading?')}\n            </a>\n            <VideoDoesNotLoadModal\n              isActive={showVideoDoesNotLoadModal}\n              onClose={handleCloseVideoDoesNotLoadModal}\n            />\n            <Back>\n              <button className=\"secondary small\">{t('Go back')}</button>\n            </Back>\n          </div>\n        </div>\n      </div>\n    </div>\n  )\n}\n","import { AppDispatch, RootState } from '../store'\nimport React, { useCallback, useMemo, useState } from 'react'\nimport { useDispatch, useSelector } from 'react-redux'\nimport { ItemKind } from '../types/items/Item'\nimport { Loading } from './Loading'\nimport { NotFound } from './NotFound'\nimport { Player } from '../components/Player'\nimport { episodeSelector } from '../store/episodes/selectors'\nimport { load } from '../store/ui/thunks'\nimport { movieSelector } from '../store/movies/selectors'\nimport { updateEpisodeProgress } from '../store/episodes/thunks'\nimport { updateFiles } from '../store/thunks'\nimport { updateMovieProgress } from '../store/movies/thunks'\nimport { useAsyncMemo } from 'use-async-memo'\nimport { useLocation } from 'react-router-dom'\n\nconst KIND_PARAMETER = 'type'\nconst ID_PARAMETER = 'id'\nconst START_AT_PARAMETER = 's'\n\nconst PlayerView = () => {\n  const dispatch = useDispatch<AppDispatch>()\n  const location = useLocation()\n\n  const { episodes, movies } = useSelector((state: RootState) => ({\n    episodes: state.episodes,\n    movies: state.movies,\n  }))\n\n  const [isNotFound, setIsNotFound] = useState(false)\n\n  const startAt: number | undefined = useMemo(() => {\n    const rawStartAt = new URLSearchParams(location.search).get(\n      START_AT_PARAMETER,\n    )\n    if (rawStartAt === null) return\n\n    return Number.parseInt(rawStartAt)\n  }, [location])\n\n  const kind: ItemKind | undefined = useMemo(() => {\n    const rawKind = new URLSearchParams(location.search).get(KIND_PARAMETER)\n    if (rawKind === null) return\n\n    const kind = Number.parseInt(rawKind)\n\n    if (Object.values(ItemKind).includes(kind)) return kind\n  }, [location])\n\n  const findItem = useCallback(\n    (kind: ItemKind, id: string) => {\n      switch (kind) {\n        case ItemKind.Episode:\n          return episodeSelector(id)(episodes)\n        case ItemKind.Movie:\n          return movieSelector(id)(movies)\n      }\n    },\n    [episodes, movies],\n  )\n\n  const item = useAsyncMemo(async () => {\n    if (kind === undefined) return setIsNotFound(true)\n\n    const id = new URLSearchParams(location.search).get(ID_PARAMETER)\n    if (id === null) return setIsNotFound(true)\n\n    const item = findItem(kind, id)\n    if (item === undefined) return setIsNotFound(true)\n\n    const updatedItem = await dispatch(load(updateFiles(item)))\n    return updatedItem\n  }, [dispatch, kind, location, setIsNotFound])\n\n  const handleProgress = useCallback(\n    (progress: number) => {\n      if (item === undefined) return\n\n      switch (item.kind) {\n        case ItemKind.Episode:\n          return dispatch(updateEpisodeProgress(item, progress))\n        case ItemKind.Movie:\n          return dispatch(updateMovieProgress(item, progress))\n      }\n    },\n    [dispatch, item],\n  )\n\n  return item !== undefined && item.sources.length > 0 ? (\n    <Player item={item} startAt={startAt} onProgress={handleProgress} />\n  ) : isNotFound ? (\n    <NotFound />\n  ) : (\n    <Loading />\n  )\n}\n\nexport default PlayerView\n","import { AppThunk } from '../index'\nimport { Movie } from '../../types/items/Movie'\nimport { Usage } from '../../types/items/Item'\nimport { updateMovie } from './actions'\n\nexport const updateMovieProgress =\n  (movie: Movie, progress: number): AppThunk<void> =>\n  (dispatch) => {\n    const usage: Usage = {\n      lastWatched: new Date().toISOString(),\n      progress,\n    }\n    dispatch(updateMovie({ ...movie, usage }))\n  }\n\nexport const removeFilesByProvider =\n  (movie: Movie, providerId: string): AppThunk<void> =>\n  (dispatch) => {\n    dispatch(\n      updateMovie({\n        ...movie,\n        sources: movie.sources.filter(\n          (source) => source.provider.providerId !== providerId,\n        ),\n        captions: movie.captions.filter(\n          (caption) => caption.provider.providerId !== providerId,\n        ),\n      }),\n    )\n  }\n"],"names":["Back","children","navigate","useNavigate","isDisabled","history","length","handleClick","useCallback","className","classNames","disabled","onClick","findProvider","providers","providerId","provider","find","id","undefined","Error","buildSource","video","src","buildFileDownloadUrl","type","buildVideoType","size","buildVideoSize","buildCaption","caption","kind","label","name","srcLang","buildCaptionSrcLang","PlyrPlayer","item","startAt","onProgress","useSelector","state","providersSelector","auth","useEffect","hasForwarded","player","Plyr","debug","process","controls","settings","autoplay","invertTime","toggleInvert","source","title","sources","map","tracks","captions","on","duration","forward","buildItemUrl","ended","currentTime","destroy","crossOrigin","playsInline","VideoDoesNotLoadModal","isActive","onClose","t","useTranslation","handleReload","window","location","reload","Modal","href","target","rel","Player","useModal","showVideoDoesNotLoadModal","handleShowVideoDoesNotLoadModal","handleCloseVideoDoesNotLoadModal","to","e","preventDefault","dispatch","useDispatch","useLocation","episodes","movies","useState","isNotFound","setIsNotFound","useMemo","rawStartAt","URLSearchParams","search","get","Number","parseInt","rawKind","Object","values","ItemKind","includes","findItem","episodeSelector","movieSelector","useAsyncMemo","load","updateFiles","updatedItem","handleProgress","progress","updateEpisodeProgress","movie","usage","lastWatched","Date","toISOString","updateMovie","updateMovieProgress","NotFound","Loading"],"sourceRoot":""}